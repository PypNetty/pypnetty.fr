---
import Layout from "../../layouts/Layout.astro";
import BlogSidebar from "../../components/BlogSidebar.astro";
import { getCollection } from "astro:content";
import { formatDate } from "../../utils/formatDate";

const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const sortedPosts = allPosts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Extraire tous les tags uniques
const allTags = [...new Set(allPosts.flatMap((post) => post.data.tags || []))];
const tagCounts = allTags.map((tag) => ({
  name: tag,
  count: allPosts.filter((post) => post.data.tags?.includes(tag)).length,
}));
---

<Layout
  title="Blog - PypNetty"
  description="Journal d'un architecte Infrastructure : Kubernetes, DevOps et DevOps de terrain"
>
  <div class="blog-container">
    <!-- Header Section -->
    <div class="blog-header">
      <h1 class="blog-title">Blog</h1>
      <p class="blog-subtitle">
        Journal d'un architecte Infrastructure : Kubernetes, DevOps et DevOps de
        terrain
      </p>
    </div>

    <!-- Search Bar -->
    <div class="search-container">
      <div class="search-wrapper">
        <svg
          class="search-icon"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input
          type="search"
          id="searchInput"
          placeholder="Rechercher un article..."
          class="search-input"
        />
      </div>
    </div>

    <!-- Main Content with Sidebar -->
    <div class="blog-layout">
      <!-- Main Content -->
      <div class="blog-main">
        <!-- Filter Tags -->
        <div class="filter-tags">
          <button class="filter-tag active" data-category="all">
            Tous ({sortedPosts.length})
          </button>
          {
            tagCounts.map((tag) => (
              <button class="filter-tag" data-category={tag.name.toLowerCase()}>
                {tag.name} ({tag.count})
              </button>
            ))
          }
        </div>

        <!-- Articles Grid -->
        <div class="articles-grid">
          {
            sortedPosts.map((post) => (
              <article
                class="article-card"
                data-tags={post.data.tags?.join(",").toLowerCase()}
              >
                <div class="article-icon">
                  {post.data.tags?.[0] === "DevOps" && "‚öôÔ∏è"}
                  {post.data.tags?.[0] === "Kubernetes" && "‚ò∏Ô∏è"}
                  {post.data.tags?.[0] === "Go" && "üîµ"}
                  {post.data.tags?.[0] === "Cloud" && "‚òÅÔ∏è"}
                  {!["DevOps", "Kubernetes", "Go", "Cloud"].includes(
                    post.data.tags?.[0] || ""
                  ) && "üìù"}
                </div>
                <div class="article-content">
                  <h2 class="article-title">
                    <a href={`/blog/${post.slug}`}>{post.data.title}</a>
                  </h2>
                  <p class="article-description">{post.data.description}</p>
                  <div class="article-meta">
                    <time datetime={post.data.pubDate.toISOString()}>
                      {formatDate(post.data.pubDate)}
                    </time>
                    <span class="meta-separator">‚Ä¢</span>
                    <span>5 min de lecture</span>
                  </div>
                </div>
              </article>
            ))
          }
        </div>

        <!-- Pagination -->
        <div class="pagination">
          <button class="pagination-btn active">1</button>
          <button class="pagination-btn">2</button>
          <button class="pagination-btn">3</button>
          <button class="pagination-btn">&gt;</button>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="blog-sidebar-wrapper">
        <BlogSidebar />
      </div>
    </div>
  </div>
</Layout>

<style>
  .blog-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .blog-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .blog-title {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: #e4e4e7;
  }

  .blog-subtitle {
    font-size: 1.125rem;
    color: #a1a1aa;
    max-width: 600px;
    margin: 0 auto;
  }

  .search-container {
    max-width: 600px;
    margin: 0 auto 2rem;
  }

  .search-wrapper {
    position: relative;
  }

  .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    width: 1.25rem;
    height: 1.25rem;
    color: #71717a;
  }

  .search-input {
    width: 100%;
    padding: 0.875rem 1rem 0.875rem 3rem;
    background: #1a1a2e;
    border: 1px solid #2a2a3e;
    border-radius: 8px;
    color: #e4e4e7;
    font-size: 1rem;
    transition: all 0.2s;
  }

  .search-input:focus {
    outline: none;
    border-color: #10b981;
  }

  .search-input::placeholder {
    color: #71717a;
  }

  .blog-layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 2rem;
  }

  @media (max-width: 1024px) {
    .blog-layout {
      grid-template-columns: 1fr;
    }

    .blog-sidebar-wrapper {
      display: none;
    }
  }

  .filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 2rem;
  }

  .filter-tag {
    padding: 0.5rem 1rem;
    background: #1a1a2e;
    border: 1px solid #2a2a3e;
    border-radius: 6px;
    color: #a1a1aa;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .filter-tag:hover {
    border-color: #10b981;
    color: #e4e4e7;
  }

  .filter-tag.active {
    background: #10b981;
    border-color: #10b981;
    color: #000;
    font-weight: 600;
  }

  .articles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .article-card {
    background: #1a1a2e;
    border: 1px solid #2a2a3e;
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s;
    display: flex;
    gap: 1rem;
  }

  .article-card:hover {
    border-color: #10b981;
    transform: translateY(-4px);
  }

  .article-icon {
    flex-shrink: 0;
    width: 3rem;
    height: 3rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    background: #0f0f1a;
    border-radius: 8px;
  }

  .article-content {
    flex: 1;
    min-width: 0;
  }

  .article-title {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    line-height: 1.4;
  }

  .article-title a {
    color: #e4e4e7;
    text-decoration: none;
    transition: color 0.2s;
  }

  .article-title a:hover {
    color: #10b981;
  }

  .article-description {
    color: #a1a1aa;
    font-size: 0.875rem;
    margin-bottom: 0.75rem;
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .article-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #71717a;
    font-size: 0.75rem;
  }

  .meta-separator {
    color: #3f3f46;
  }

  .pagination {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    padding: 2rem 0;
  }

  .pagination-btn {
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #1a1a2e;
    border: 1px solid #2a2a3e;
    border-radius: 6px;
    color: #a1a1aa;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
  }

  .pagination-btn:hover {
    border-color: #10b981;
    color: #e4e4e7;
  }

  .pagination-btn.active {
    background: #10b981;
    border-color: #10b981;
    color: #000;
  }
</style>

<script>
  // Search functionality
  const searchInput = document.getElementById(
    "searchInput"
  ) as HTMLInputElement;
  const articles = document.querySelectorAll<HTMLElement>(".article-card");

  searchInput?.addEventListener("input", (e) => {
    const query = (e.target as HTMLInputElement).value.toLowerCase();

    articles.forEach((article) => {
      const title =
        article.querySelector(".article-title")?.textContent?.toLowerCase() ||
        "";
      const description =
        article
          .querySelector(".article-description")
          ?.textContent?.toLowerCase() || "";

      if (title.includes(query) || description.includes(query)) {
        article.style.display = "";
      } else {
        article.style.display = "none";
      }
    });
  });

  // Filter functionality
  const filterTags =
    document.querySelectorAll<HTMLButtonElement>(".filter-tag");

  filterTags.forEach((tag) => {
    tag.addEventListener("click", () => {
      // Update active state
      filterTags.forEach((t) => t.classList.remove("active"));
      tag.classList.add("active");

      const category = tag.dataset.category;

      articles.forEach((article) => {
        const tags = article.dataset.tags || "";

        if (category === "all" || tags.includes(category || "")) {
          article.style.display = "";
        } else {
          article.style.display = "none";
        }
      });
    });
  });
</script>

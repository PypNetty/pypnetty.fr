---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";

const allPosts = await getCollection("blog");
const sortedPosts = allPosts.sort(
  (a, b) =>
    new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
);

// Categories avec counts
const categories = {
  Cloud: sortedPosts.filter((p) => p.data.tags?.includes("cloud")).length,
  DevEx: sortedPosts.filter((p) => p.data.tags?.includes("devex")).length,
  DevOps: sortedPosts.filter((p) => p.data.tags?.includes("devops")).length,
  FinOps: sortedPosts.filter((p) => p.data.tags?.includes("finops")).length,
  IaC: sortedPosts.filter((p) => p.data.tags?.includes("iac")).length,
  Projets: sortedPosts.filter((p) => p.data.tags?.includes("projets")).length,
  Security: sortedPosts.filter((p) => p.data.tags?.includes("security")).length,
};

// Recent articles sidebar
const recentPosts = sortedPosts.slice(0, 5);
---

<Layout title="Blog - PypNetty">
  <main class="max-w-6xl mx-auto px-6 py-12">
    <div class="mb-16">
      <div class="relative max-w-xl mx-auto mb-8">
        <input
          type="text"
          id="search-input"
          placeholder="Rechercher un article..."
          class="w-full bg-blog-card/40 border border-white/5 rounded-lg py-3 px-10 text-sm focus:outline-none focus:border-blog-accent/50 transition-all"
        />
        <span class="absolute left-3 top-3.5 opacity-30 text-sm">üîç</span>
      </div>
      <div class="flex flex-wrap justify-center gap-2">
        <button
          class="filter-tag active px-3 py-1.5 bg-blog-tag/30 hover:bg-blog-tag text-[11px] text-gray-400 rounded-md transition"
          data-category="all"
        >
          Tous ({sortedPosts.length})
        </button>
        {
          Object.entries(categories).map(([cat, count]) => (
            <button
              class="filter-tag px-3 py-1.5 bg-blog-tag/30 hover:bg-blog-tag text-[11px] text-gray-400 rounded-md transition"
              data-category={cat.toLowerCase()}
            >
              {cat} ({count})
            </button>
          ))
        }
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
      <div class="lg:col-span-8">
        <!-- Featured Article -->
        {
          sortedPosts[0] && (
            <article
              class="article-card relative bg-blog-card/30 border border-white/10 rounded-xl p-8 mb-10 overflow-hidden group cursor-pointer hover:border-blog-accent hover:bg-blog-accent/5 hover:shadow-xl hover:shadow-blog-accent/20 hover:-translate-y-1 transition-all duration-300"
              data-tags={sortedPosts[0].data.tags?.join(",").toLowerCase()}
            >
              <a href={`/blog/${sortedPosts[0].slug}`} class="block">
                <div class="relative z-10">
                  <div class="flex items-center gap-4 text-[10px] text-gray-500 uppercase tracking-widest mb-4 group-hover:text-gray-400 transition-colors">
                    <span>
                      {new Date(sortedPosts[0].data.pubDate).toLocaleDateString(
                        "fr-FR"
                      )}
                    </span>
                    <span>
                      ‚Ä¢ {sortedPosts[0].data.readingTime || "5"} min de lecture
                    </span>
                    <span class="text-green-500 bg-green-500/10 px-2 py-0.5 rounded group-hover:bg-green-500/20 transition-colors">
                      Dernier Article
                    </span>
                  </div>
                  <div class="flex flex-col md:flex-row gap-8 items-center">
                    <div class="w-32 h-32 bg-gradient-to-br from-blog-accent/20 to-purple-500/20 rounded-2xl flex items-center justify-center border border-white/5 shadow-2xl group-hover:scale-105 group-hover:from-blog-accent/30 group-hover:to-purple-500/30 group-hover:border-blog-accent/30 transition-all duration-300">
                      <span class="text-4xl">üìù</span>
                    </div>
                    <div>
                      <h2 class="text-2xl font-bold mb-4 group-hover:text-blog-accent transition-colors duration-300">
                        {sortedPosts[0].data.title}
                      </h2>
                      <p class="text-blog-text text-sm mb-6 leading-relaxed group-hover:text-gray-300 transition-colors">
                        {sortedPosts[0].data.description}
                      </p>
                      <span class="text-blog-accent text-sm font-medium group-hover:translate-x-1 inline-block transition-transform">
                        Lire l'article ‚Üí
                      </span>
                    </div>
                  </div>
                </div>
              </a>
            </article>
          )
        }

        <!-- Articles Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          {
            sortedPosts.slice(1).map((post) => (
              <article
                class="article-card bg-blog-card/20 border border-white/10 rounded-xl p-6 hover:border-blog-accent hover:bg-blog-accent/5 hover:shadow-xl hover:shadow-blog-accent/20 hover:-translate-y-1 transition-all duration-300 flex flex-col justify-between group cursor-pointer"
                data-tags={post.data.tags?.join(",").toLowerCase()}
              >
                <a
                  href={`/blog/${post.slug}`}
                  class="block h-full flex flex-col"
                >
                  <div class="flex-1">
                    <div class="flex justify-between items-start mb-6">
                      <div class="w-10 h-10 bg-blog-tag/50 rounded flex items-center justify-center border border-white/5 group-hover:scale-110 group-hover:bg-blog-accent/20 group-hover:border-blog-accent/30 transition-all duration-300">
                        üì¶
                      </div>
                      {post.data.tags && post.data.tags[0] && (
                        <span class="text-[10px] text-blog-accent uppercase font-bold tracking-widest group-hover:text-green-400 transition-colors">
                          {post.data.tags[0]}
                        </span>
                      )}
                    </div>
                    <h3 class="text-lg font-bold mb-3 leading-snug group-hover:text-blog-accent transition-colors duration-300">
                      {post.data.title}
                    </h3>
                    <p class="text-blog-text text-xs leading-relaxed mb-6 opacity-80 group-hover:opacity-100 group-hover:text-gray-300 transition-all">
                      {post.data.description}
                    </p>
                  </div>
                  <div class="flex justify-between text-[10px] text-gray-500 border-t border-white/5 pt-4">
                    <span>
                      {new Date(post.data.pubDate).toLocaleDateString("fr-FR")}
                    </span>
                    <span>{post.data.readingTime || "5"} min de lecture</span>
                  </div>
                </a>
              </article>
            ))
          }
        </div>

        <!-- Pagination -->
        <div class="mt-12 flex justify-center gap-2 font-mono text-sm">
          <button
            class="px-3 py-1 border border-white/10 rounded bg-blog-accent text-blog-bg"
            >1</button
          >
          <button
            class="px-3 py-1 border border-white/10 rounded hover:bg-white/5"
            >2</button
          >
          <span class="px-3 py-1">...</span>
          <button
            class="px-3 py-1 border border-white/10 rounded hover:bg-white/5"
            >5</button
          >
        </div>
      </div>

      <!-- Sidebar -->
      <aside class="lg:col-span-4 space-y-6">
        {
          ["Cloud", "DevEx", "DevOps", "FinOps"].map((section) => (
            <div class="border border-white/5 rounded-lg p-5 bg-blog-card/10">
              <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-[0.2em] mb-4 flex items-center gap-2">
                <span class="w-2 h-2 bg-blog-accent rounded-full animate-pulse" />{" "}
                {section}
              </h4>
              <ul class="space-y-4">
                {recentPosts
                  .filter((p) => p.data.tags?.includes(section.toLowerCase()))
                  .slice(0, 3)
                  .map((post) => (
                    <li class="text-xs text-blog-text hover:text-white cursor-pointer">
                      <a
                        href={`/blog/${post.slug}`}
                        class="flex gap-3 items-start"
                      >
                        <div class="w-6 h-6 bg-white/5 rounded flex-shrink-0" />
                        <p class="leading-snug">{post.data.title}</p>
                      </a>
                    </li>
                  ))}
              </ul>
            </div>
          ))
        }
      </aside>
    </div>
  </main>
</Layout>

<script>
  // Search functionality
  const searchInput = document.getElementById("search-input");
  const articles = document.querySelectorAll(".article-card");

  searchInput?.addEventListener("input", (e) => {
    const query = (e.target as HTMLInputElement).value.toLowerCase();

    articles.forEach((article) => {
      const title = article.querySelector("h2, h3")?.textContent?.toLowerCase();
      const excerpt = article.querySelector("p")?.textContent?.toLowerCase();

      if (title?.includes(query) || excerpt?.includes(query)) {
        (article as HTMLElement).style.display = "";
      } else {
        (article as HTMLElement).style.display = "none";
      }
    });
  });

  // Filter functionality
  const filterTags = document.querySelectorAll(".filter-tag");

  filterTags.forEach((tag) => {
    tag.addEventListener("click", () => {
      const category = (tag as HTMLElement).dataset.category;

      // Toggle active
      filterTags.forEach((t) => t.classList.remove("active"));
      tag.classList.add("active");

      // Filter articles
      articles.forEach((article) => {
        const articleTags = (article as HTMLElement).dataset.tags || "";

        if (category === "all" || articleTags.includes(category || "")) {
          (article as HTMLElement).style.display = "";
        } else {
          (article as HTMLElement).style.display = "none";
        }
      });
    });
  });
</script>

---
const { title = "bash", defaultHostname = "container-demo" } = Astro.props;
---

<div
  class="my-8 font-mono text-sm rounded-lg overflow-hidden border border-gray-800 bg-[#0d1117] shadow-2xl terminal-widget"
  data-default-hostname={defaultHostname}
>
  <div
    class="bg-[#161b22] px-4 py-2 border-b border-gray-800 flex justify-between items-center"
  >
    <div class="flex gap-2">
      <div class="w-3 h-3 rounded-full bg-red-500/50"></div>
      <div class="w-3 h-3 rounded-full bg-yellow-500/50"></div>
      <div class="w-3 h-3 rounded-full bg-green-500/50"></div>
    </div>
    <div class="text-gray-500 text-xs">{title} — zsh — 80x24</div>
    <div class="w-10"></div>
  </div>

  <div
    class="bg-[#0d1117] border-b border-gray-800 p-4 flex items-center gap-4"
  >
    <label class="text-purple-400 font-bold text-xs uppercase tracking-widest">
      Set Hostname:
    </label>
    <div class="relative flex-1">
      <span class="absolute left-3 top-2 text-gray-500">&gt;</span>
      <input
        type="text"
        class="terminal-hostname-input w-full bg-[#161b22] text-white border border-gray-700 rounded px-3 pl-6 py-1 focus:border-purple-500 focus:outline-none transition-colors"
        value={defaultHostname}
      />
    </div>
    <button
      class="terminal-run-btn bg-green-600 hover:bg-green-500 text-white px-4 py-1 rounded text-xs font-bold transition-colors"
    >
      RUN_CODE
    </button>
  </div>

  <div class="p-4 text-gray-300 space-y-2 min-h-[200px]">
    <div class="flex gap-2">
      <span class="text-green-500">root@host:~$</span>
      <span>
        sudo go run main.go child
        <span class="terminal-arg text-yellow-400">{defaultHostname}</span>
      </span>
    </div>

    <div class="terminal-output opacity-50"></div>

    <div class="terminal-cursor hidden">
      <span class="text-green-500"
        >root@<span class="terminal-prompt-hostname">host</span>:~$</span
      >
      <span class="w-2 h-4 bg-gray-500 inline-block animate-pulse align-middle"
      ></span>
    </div>
  </div>
</div>

<script>
  const widgets = document.querySelectorAll(".terminal-widget");

  widgets.forEach((widget) => {
    const input = widget.querySelector(".terminal-hostname-input");
    const argDisplay = widget.querySelector(".terminal-arg");
    const runBtn = widget.querySelector(".terminal-run-btn");
    const outputArea = widget.querySelector(".terminal-output");
    const cursorLine = widget.querySelector(".terminal-cursor");
    const promptHostname = widget.querySelector(".terminal-prompt-hostname");

    if (
      !input ||
      !argDisplay ||
      !runBtn ||
      !outputArea ||
      !cursorLine ||
      !promptHostname
    ) {
      return;
    }

    input.addEventListener("input", (e) => {
      const value = (e.target as HTMLInputElement)?.value ?? "";
      argDisplay.textContent = value;
    });

    runBtn.addEventListener("click", async () => {
      const hostname = (input as HTMLInputElement).value || "unknown";

      (outputArea as HTMLElement).innerHTML = "";
      (outputArea as HTMLElement).classList.remove("opacity-50");
      (cursorLine as HTMLElement).classList.add("hidden");

      addToTerminal(
        outputArea as HTMLElement,
        "Compiling main.go...",
        "text-gray-500",
      );
      await wait(600);

      addToTerminal(
        outputArea as HTMLElement,
        "Running [child process] as PID 24500",
        "text-white",
      );
      await wait(400);

      addToTerminal(
        outputArea as HTMLElement,
        "> Syscall: CLONE_NEWUTS | CLONE_NEWPID",
        "text-purple-400 font-bold",
      );
      await wait(800);

      addToTerminal(
        outputArea as HTMLElement,
        "Process requires new namespace... OK",
        "text-green-400",
      );
      addToTerminal(
        outputArea as HTMLElement,
        "Switched to PID 1 (Isolated)",
        "text-yellow-400 font-bold",
      );

      await wait(500);
      addToTerminal(
        outputArea as HTMLElement,
        `> Setting Hostname to "${hostname}"...`,
        "text-white",
      );

      await wait(500);
      addToTerminal(
        outputArea as HTMLElement,
        "Done. Spawning shell...",
        "text-gray-500",
      );

      promptHostname.textContent = hostname;
      cursorLine.classList.remove("hidden");
    });
  });

  function addToTerminal(
    outputArea: HTMLElement,
    text: string | null,
    classes = "",
  ): void {
    const div = document.createElement("div");
    if (classes) div.className = classes;
    div.textContent = text;
    outputArea.appendChild(div);
  }

  function wait(ms: number | undefined) {
    return new Promise((resolve) => setTimeout(resolve, ms));
  }
</script>

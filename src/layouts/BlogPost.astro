---
import Layout from "./Layout.astro";
import { formatDate } from "../utils/formatDate";
import { getCollection } from "astro:content";
import { siteConfig } from "../config/site";

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  updatedDate?: Date;
  tags: string[];
  readingTime?: string;
  slug: string;
  image?: string;
}

const {
  title,
  description,
  pubDate,
  updatedDate,
  tags,
  readingTime,
  slug,
  image = "/og-image.jpg",
} = Astro.props;

// Configuration de l'auteur
const author = siteConfig.author;
type SocialLink = {
  url: string;
  username: string;
  icon: string;
  label: string;
};

// R√©cup√©rer tous les articles pour la sidebar
const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const recentPosts = allPosts
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 8);
---

<Layout title={title} description={description} image={image} article={true}>
  <!-- Reading Progress Bar -->
  <div
    id="reading-progress"
    class="fixed top-0 left-0 h-[2px] bg-emerald-500 z-[100] transition-all duration-150 ease-out"
    style="width: 0%"
  >
  </div>

  <div class="blog-article-container">
    <!-- Left Sidebar: Table of Contents -->
    <aside class="toc-sidebar">
      <div class="sidebar-window-left">
        <div class="window-header">
          <h3>Sommaire</h3>
        </div>

        <div class="toc-content">
          <h4 class="toc-section-title"># SUR CETTE PAGE</h4>
          <nav class="toc-nav" id="toc">
            <!-- Sera rempli par JavaScript -->
          </nav>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <article class="article-content-main">
      <!-- Navigation breadcrumb et Back -->
      <div class="article-nav-bar">
        <div class="breadcrumb">
          <a href="/">üè† Home</a>
          <span class="separator">‚Ä∫</span>
          <a href="/blog">üìù Blog</a>
          <span class="separator">‚Ä∫</span>
          <span class="current">{title}</span>
        </div>
        <a href="/blog" class="back-button">‚Üê Back</a>
      </div>

      <!-- Article Header -->
      <div class="article-header-section">
        <h1 class="article-main-title">{title}</h1>

        <div class="article-meta-info">
          <time datetime={pubDate.toISOString()}>
            {formatDate(pubDate)}
          </time>
          {
            readingTime && (
              <>
                <span class="separator">‚Ä¢</span>
                <span>{readingTime}</span>
              </>
            )
          }
        </div>

        <div class="article-tags-list">
          {tags.map((tag) => <span class="article-tag-badge">{tag}</span>)}
        </div>
      </div>

      <!-- Article Content -->
      <div class="prose-content">
        <slot />
      </div>

      <!-- Article Footer -->
      <div class="article-footer-section">
        <div class="author-card-full">
          <div class="author-avatar-large">
            <img src={author.avatar} alt={author.name} />
          </div>
          <div class="author-details">
            <h4>{author.name}</h4>
            <p>{author.title}</p>
            <p class="author-desc">{author.bio}</p>
            <div class="author-social-links">
              {
                Object.entries(author.social).map(([key, social]) => {
                  const socialLink = social as SocialLink;
                  return (
                    <a
                      href={socialLink.url}
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      {socialLink.icon} {socialLink.label}
                    </a>
                  );
                })
              }
            </div>
          </div>
        </div>

        <div class="comments-section">
          <h3>üí¨ Commentaires</h3>
          <p class="comments-placeholder">
            Les commentaires seront bient√¥t disponibles...
          </p>
        </div>
      </div>
    </article>

    <!-- Right Sidebar: Similar Posts by Category -->
    <aside class="recent-sidebar">
      <div class="sidebar-window">
        <h3 class="sidebar-title">Articles similaires</h3>

        <div class="categories-list">
          <!-- DevOps Category -->
          <div class="category-group">
            <h4 class="category-title">DevOps/</h4>
            <div class="category-posts">
              {
                allPosts
                  .filter((p) => p.data.tags?.includes("DevOps"))
                  .slice(0, 3)
                  .map((post) => (
                    <a href={`/blog/${post.slug}`} class="category-post-item">
                      <span class="post-icon">‚ò∏Ô∏è</span>
                      <span class="post-title">{post.data.title}</span>
                    </a>
                  ))
              }
            </div>
          </div>

          <!-- DevEx Category -->
          <div class="category-group">
            <h4 class="category-title">DevEx/</h4>
            <div class="category-posts">
              {
                allPosts
                  .filter((p) => p.data.tags?.includes("DevEx"))
                  .slice(0, 3)
                  .map((post) => (
                    <a href={`/blog/${post.slug}`} class="category-post-item">
                      <span class="post-icon">üíª</span>
                      <span class="post-title">{post.data.title}</span>
                    </a>
                  ))
              }
            </div>
          </div>

          <!-- IaC Category -->
          <div class="category-group">
            <h4 class="category-title">IaC/</h4>
            <div class="category-posts">
              {
                allPosts
                  .filter((p) => p.data.tags?.includes("Infrastructure"))
                  .slice(0, 3)
                  .map((post) => (
                    <a href={`/blog/${post.slug}`} class="category-post-item">
                      <span class="post-icon">üîß</span>
                      <span class="post-title">{post.data.title}</span>
                    </a>
                  ))
              }
            </div>
          </div>

          <!-- FinOps Category -->
          <div class="category-group">
            <h4 class="category-title">FinOps/</h4>
            <div class="category-posts">
              {
                allPosts
                  .filter((p) => p.data.tags?.includes("FinOps"))
                  .slice(0, 3)
                  .map((post) => (
                    <a href={`/blog/${post.slug}`} class="category-post-item">
                      <span class="post-icon">üí∞</span>
                      <span class="post-title">{post.data.title}</span>
                    </a>
                  ))
              }
            </div>
          </div>

          <!-- All Posts Link -->
          <div class="category-group">
            <a href="/blog" class="all-posts-link"> ../ [Tout] </a>
          </div>
        </div>
      </div>
    </aside>
  </div>
</Layout>

<style>
  .blog-article-container {
    display: grid;
    grid-template-columns: 240px 1fr 280px;
    gap: 2rem;
    max-width: 1600px;
    margin: 0 auto;
    padding: 0;
    background: #0d0d1b;
    min-height: 100vh;
  }

  @media (max-width: 1280px) {
    .blog-article-container {
      grid-template-columns: 200px 1fr 250px;
      gap: 1.5rem;
    }
  }

  @media (max-width: 1024px) {
    .blog-article-container {
      grid-template-columns: 1fr;
      padding: 1rem;
    }

    .toc-sidebar,
    .recent-sidebar {
      display: none;
    }
  }

  /* Navigation bar avec breadcrumb */
  .article-nav-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 0 1.5rem 0;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid #2a2a3e;
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #71717a;
  }

  .breadcrumb a {
    color: #71717a;
    text-decoration: none;
    transition: color 0.2s;
  }

  .breadcrumb a:hover {
    color: #10b981;
  }

  .breadcrumb .separator {
    color: #3f3f46;
  }

  .breadcrumb .current {
    color: #a1a1aa;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 400px;
  }

  /* Bouton retour */
  .back-button {
    display: inline-block;
    margin-bottom: 1.5rem;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    color: #71717a;
    text-decoration: none;
    border: 1px solid #2a2a3e;
    border-radius: 4px;
    transition: all 0.2s;
  }

  .back-button:hover {
    color: #10b981;
    border-color: #10b981;
  }

  /* Left Sidebar */
  .toc-sidebar {
    background: #1a1a2e;
    border-right: 1px solid #2a2a3e;
    padding: 0;
    position: sticky;
    top: 4rem;
    height: calc(100vh - 4rem);
    overflow-y: auto;
  }

  .sidebar-window-left {
    background: #16162a;
    border: 1px solid #2a2a3e;
    border-radius: 8px;
    margin: 1.5rem;
    overflow: hidden;
  }

  .window-header {
    background: #1a1a2e;
    border-bottom: 1px solid #2a2a3e;
    padding: 0.75rem 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .window-header::before {
    content: "";
    display: flex;
    gap: 0.375rem;
  }

  .window-header h3 {
    font-size: 0.875rem;
    font-weight: 500;
    color: #a1a1aa;
    margin: 0;
  }

  .toc-content {
    padding: 1.25rem;
  }

  .toc-section-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: #71717a;
    margin-bottom: 1rem;
    font-family: "JetBrains Mono", monospace;
    letter-spacing: 0.05em;
  }

  .toc-nav {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .toc-nav :global(a) {
    display: block;
    padding: 0.5rem 0.75rem;
    color: #a1a1aa;
    text-decoration: none;
    font-size: 0.875rem;
    border-left: 2px solid transparent;
    transition: all 0.2s;
    line-height: 1.5;
  }

  .toc-nav :global(a:hover) {
    color: #e4e4e7;
    background: #1a1a2e;
  }

  .toc-nav :global(a.active) {
    color: #10b981;
    border-left-color: #10b981;
    background: #1a1a2e;
  }

  .toc-nav :global(a[data-level="h3"]) {
    padding-left: 1.5rem;
    font-size: 0.8125rem;
  }

  /* Main Content */
  .article-content-main {
    background: #16162a;
    padding: 3rem 4rem;
    max-width: 900px;
  }

  @media (max-width: 768px) {
    .article-content-main {
      padding: 2rem 1.5rem;
    }
  }

  .article-header-section {
    margin-bottom: 3rem;
  }

  .article-main-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: #e4e4e7;
    line-height: 1.2;
    margin-bottom: 1rem;
  }

  @media (max-width: 768px) {
    .article-main-title {
      font-size: 2rem;
    }
  }

  .article-meta-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: #71717a;
    font-size: 0.875rem;
    margin-bottom: 1.5rem;
  }

  .separator {
    color: #3f3f46;
  }

  .article-tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .article-tag-badge {
    padding: 0.375rem 0.875rem;
    background: #1f1f3a;
    border: 1px solid #2a2a4e;
    border-radius: 4px;
    color: #9ca3ff;
    font-size: 0.8125rem;
    font-weight: 500;
  }

  /* Prose Content Styles */
  .prose-content {
    color: #d4d4d8;
    font-size: 1rem;
    line-height: 1.8;
  }

  .prose-content :global(h2) {
    font-size: 1.75rem;
    font-weight: 700;
    color: #e4e4e7;
    margin-top: 3rem;
    margin-bottom: 1.5rem;
    scroll-margin-top: 5rem;
  }

  .prose-content :global(h3) {
    font-size: 1.375rem;
    font-weight: 600;
    color: #e4e4e7;
    margin-top: 2rem;
    margin-bottom: 1rem;
    scroll-margin-top: 5rem;
  }

  .prose-content :global(p) {
    margin-bottom: 1.5rem;
    color: #b4b4b8;
  }

  .prose-content :global(a) {
    color: #10b981;
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s;
  }

  .prose-content :global(a:hover) {
    border-bottom-color: #10b981;
  }

  .prose-content :global(code) {
    background: #1a1a2e;
    padding: 0.25rem 0.5rem;
    border-radius: 3px;
    color: #9ca3ff;
    font-size: 0.875em;
    font-family: "JetBrains Mono", monospace;
  }

  .prose-content :global(pre) {
    background: #0d0d1b;
    border: 1px solid #2a2a3e;
    border-radius: 8px;
    padding: 1.5rem;
    overflow-x: auto;
    margin: 2rem 0;
    line-height: 1.6;
  }

  .prose-content :global(pre code) {
    background: none;
    padding: 0;
    color: #d4d4d8;
    font-size: 0.875rem;
  }

  .prose-content :global(ul),
  .prose-content :global(ol) {
    margin: 1.5rem 0;
    padding-left: 1.75rem;
  }

  .prose-content :global(li) {
    margin: 0.5rem 0;
    color: #b4b4b8;
  }

  .prose-content :global(li::marker) {
    color: #71717a;
  }

  .prose-content :global(blockquote) {
    border-left: 3px solid #3f3f5e;
    padding-left: 1.5rem;
    margin: 2rem 0;
    color: #9ca3af;
    font-style: italic;
  }

  .prose-content :global(img) {
    border-radius: 8px;
    margin: 2rem 0;
    max-width: 100%;
    border: 1px solid #2a2a3e;
  }

  .prose-content :global(hr) {
    border: none;
    border-top: 1px solid #2a2a3e;
    margin: 3rem 0;
  }

  .prose-content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
  }

  .prose-content :global(th),
  .prose-content :global(td) {
    padding: 0.75rem 1rem;
    border: 1px solid #2a2a3e;
    text-align: left;
  }

  .prose-content :global(th) {
    background: #1a1a2e;
    font-weight: 600;
    color: #e4e4e7;
  }

  .prose-content :global(td) {
    background: #16162a;
  }

  /* Article Footer */
  .article-footer-section {
    margin-top: 4rem;
    padding-top: 3rem;
    border-top: 1px solid #2a2a3e;
  }

  .author-card-full {
    display: flex;
    gap: 1.5rem;
    padding: 2rem;
    background: #1a1a2e;
    border: 1px solid #2a2a3e;
    border-radius: 8px;
    margin-bottom: 3rem;
  }

  .author-avatar-large {
    width: 4rem;
    height: 4rem;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
  }

  .author-avatar-large img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .author-details h4 {
    font-size: 1.125rem;
    font-weight: 700;
    color: #e4e4e7;
    margin-bottom: 0.25rem;
  }

  .author-details p {
    color: #a1a1aa;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
  }

  .author-details .author-desc {
    color: #71717a;
    line-height: 1.6;
    margin-bottom: 1rem;
  }

  .author-social-links {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .author-social-links a {
    color: #10b981;
    text-decoration: none;
    font-size: 0.875rem;
    transition: color 0.2s;
  }

  .author-social-links a:hover {
    color: #059669;
    text-decoration: underline;
  }

  .comments-section {
    padding: 2rem;
    background: #1a1a2e;
    border: 1px solid #2a2a3e;
    border-radius: 8px;
  }

  .comments-section h3 {
    font-size: 1.25rem;
    font-weight: 700;
    color: #e4e4e7;
    margin-bottom: 1rem;
  }

  .comments-placeholder {
    color: #71717a;
    font-style: italic;
  }

  /* Right Sidebar */
  .recent-sidebar {
    background: #1a1a2e;
    border-left: 1px solid #2a2a3e;
    padding: 0;
    position: sticky;
    top: 4rem;
    height: calc(100vh - 4rem);
    overflow-y: auto;
  }

  .sidebar-window {
    background: #16162a;
    border: 1px solid #2a2a3e;
    border-radius: 8px;
    margin: 1.5rem;
    overflow: hidden;
  }

  .sidebar-title {
    font-size: 0.9375rem;
    font-weight: 600;
    color: #e4e4e7;
    padding: 1rem 1.25rem;
    background: #1a1a2e;
    border-bottom: 1px solid #2a2a3e;
    margin: 0;
  }

  .categories-list {
    padding: 1rem 1.25rem;
  }

  .category-group {
    margin-bottom: 1.5rem;
  }

  .category-group:last-child {
    margin-bottom: 0;
  }

  .category-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #a1a1aa;
    margin-bottom: 0.5rem;
    font-family: "JetBrains Mono", monospace;
  }

  .category-posts {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .category-post-item {
    display: flex;
    align-items: start;
    gap: 0.75rem;
    padding: 0.625rem 0.75rem;
    background: #1a1a2e;
    border: 1px solid #2a2a3e;
    border-radius: 4px;
    text-decoration: none;
    transition: all 0.2s;
  }

  .category-post-item:hover {
    background: #1f1f3a;
    border-color: #3f3f5e;
    transform: translateX(2px);
  }

  .post-icon {
    font-size: 1rem;
    flex-shrink: 0;
    line-height: 1.4;
  }

  .post-title {
    font-size: 0.8125rem;
    color: #d4d4d8;
    line-height: 1.4;
    flex: 1;
  }

  .all-posts-link {
    display: block;
    padding: 0.625rem 0.75rem;
    background: #1a1a2e;
    border: 1px solid #2a2a3e;
    border-radius: 4px;
    color: #10b981;
    text-decoration: none;
    font-size: 0.8125rem;
    font-family: "JetBrains Mono", monospace;
    transition: all 0.2s;
  }

  .all-posts-link:hover {
    background: #1f1f3a;
    border-color: #10b981;
  }

  /* Scrollbar Styles */
  .toc-sidebar::-webkit-scrollbar,
  .recent-sidebar::-webkit-scrollbar {
    width: 6px;
  }

  .toc-sidebar::-webkit-scrollbar-track,
  .recent-sidebar::-webkit-scrollbar-track {
    background: #1a1a2e;
  }

  .toc-sidebar::-webkit-scrollbar-thumb,
  .recent-sidebar::-webkit-scrollbar-thumb {
    background: #2a2a3e;
    border-radius: 3px;
  }

  .toc-sidebar::-webkit-scrollbar-thumb:hover,
  .recent-sidebar::-webkit-scrollbar-thumb:hover {
    background: #3f3f5e;
  }
</style>

<script>
  // Generate TOC from headings
  function generateTOC() {
    const content = document.querySelector(".prose-content");
    const toc = document.getElementById("toc");

    if (!content || !toc) return;

    const headings = content.querySelectorAll("h2, h3");

    headings.forEach((heading, index) => {
      const id = heading.id || `heading-${index}`;
      if (!heading.id) heading.id = id;

      const link = document.createElement("a");
      link.href = `#${id}`;
      link.textContent = heading.textContent || "";
      link.dataset.level = heading.tagName.toLowerCase();

      link.addEventListener("click", (e) => {
        e.preventDefault();
        heading.scrollIntoView({ behavior: "smooth", block: "start" });
        history.pushState(null, "", `#${id}`);

        // Update active state
        toc.querySelectorAll("a").forEach((a) => a.classList.remove("active"));
        link.classList.add("active");
      });

      toc.appendChild(link);
    });
  }

  // Highlight active TOC link on scroll
  function updateActiveTOC() {
    const headings = document.querySelectorAll(
      ".prose-content h2, .prose-content h3"
    );
    const tocLinks = document.querySelectorAll(".toc-nav a");

    let current = "";
    let closestDistance = Infinity;

    headings.forEach((heading) => {
      const rect = heading.getBoundingClientRect();
      const distance = Math.abs(rect.top - 100);

      if (distance < closestDistance && rect.top < window.innerHeight / 2) {
        closestDistance = distance;
        current = heading.id;
      }
    });

    tocLinks.forEach((link) => {
      link.classList.remove("active");
      if (link.getAttribute("href") === `#${current}`) {
        link.classList.add("active");
      }
    });
  }

  // Update reading progress bar
  function updateReadingProgress() {
    const progressBar = document.getElementById("reading-progress");
    if (!progressBar) return;

    const windowHeight = window.innerHeight;
    const fullHeight = document.documentElement.scrollHeight;
    const scrollPosition = window.scrollY;

    // Calcul du pourcentage : (position actuelle / (hauteur totale - hauteur fen√™tre)) * 100
    const percentage = (scrollPosition / (fullHeight - windowHeight)) * 100;

    progressBar.style.width = `${Math.min(100, Math.max(0, percentage))}%`;
  }

  // Initialize on page load
  document.addEventListener("DOMContentLoaded", () => {
    generateTOC();
    updateActiveTOC();
    updateReadingProgress();
  });

  // Update on scroll
  document.addEventListener("scroll", () => {
    updateActiveTOC();
    updateReadingProgress();
  });
</script>
